# Balance 业务流程图

## 一、整体业务流程总览

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    Balance 平台业务流程                                   │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                                    ┌─────────────┐
                                    │   买家下单   │
                                    │  (Shopee)   │
                                    └──────┬──────┘
                                           │
                                           ▼
┌──────────────────────────────────────────────────────────────────────────────────────────┐
│                                      订单同步                                             │
│  ┌─────────────────┐                                      ┌─────────────────┐            │
│  │   Webhook推送    │◄─────────(主要)──┬──(补漏)─────────►│   增量定时同步    │            │
│  │  (Shopee实时)    │                  │                  │  (每30分钟)      │            │
│  └─────────────────┘                  │                  └─────────────────┘            │
└───────────────────────────────────────┼──────────────────────────────────────────────────┘
                                        │
                                        ▼
                              ┌─────────────────┐
                              │   订单入库       │
                              │  status=待发货   │
                              └────────┬────────┘
                                       │
           ┌───────────────────────────┼───────────────────────────┐
           │                           │                           │
           ▼                           ▼                           ▼
    ┌─────────────┐            ┌─────────────┐            ┌─────────────┐
    │  店主发货    │            │  运营发货    │            │  订单取消    │
    │  (自发货)    │            │  (代发货)    │            │  (买家/卖家) │
    └──────┬──────┘            └──────┬──────┘            └──────┬──────┘
           │                          │                          │
           │                          │                          │
           ▼                          ▼                          ▼
    ┌─────────────┐            ┌─────────────┐            ┌─────────────┐
    │  调用Shopee  │            │  冻结预付款  │            │  解冻预付款  │
    │  发货API     │            │  ↓           │            │  (如已冻结)  │
    └──────┬──────┘            │  转入托管    │            └─────────────┘
           │                   │  ↓           │
           │                   │  调用发货API │
           │                   └──────┬──────┘
           │                          │
           └──────────┬───────────────┘
                      │
                      ▼
              ┌─────────────┐
              │   已发货     │
              │  等待签收    │
              └──────┬──────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
        ▼            ▼            ▼
  ┌──────────┐ ┌──────────┐ ┌──────────┐
  │ 签收完成  │ │ 退货退款  │ │ 物流异常  │
  └────┬─────┘ └────┬─────┘ └────┬─────┘
       │            │            │
       ▼            ▼            ▼
  ┌──────────┐ ┌──────────┐ ┌──────────┐
  │ Shopee   │ │ 解冻退款  │ │ 人工处理  │
  │ 结算入账  │ │ 托管退回  │ │          │
  └────┬─────┘ └──────────┘ └──────────┘
       │
       ▼
  ┌──────────┐
  │ 平台结算  │
  │ 利润分成  │
  └──────────┘
```

---

## 二、用户注册与认证流程

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    用户注册流程                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │    访问注册页面   │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  填写注册信息    │
                              │  邮箱/密码/类型  │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  选择用户类型    │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┼──────────────────┐
                    │                  │                  │
                    ▼                  ▼                  ▼
             ┌───────────┐      ┌───────────┐      ┌───────────┐
             │  店主(1)   │      │  运营(5)   │      │  平台(9)   │
             │           │      │           │      │  (内部)    │
             └─────┬─────┘      └─────┬─────┘      └───────────┘
                   │                  │
                   ▼                  ▼
             ┌───────────┐      ┌───────────┐
             │ 创建账户   │      │ 创建账户   │
             │ • 预付款   │      │ • 运营账户 │
             │ • 保证金   │      └───────────┘
             │ • 佣金     │
             └───────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    用户登录流程                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │    输入账号密码   │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │    验证密码      │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                     │
                    ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │  验证成功  │                         │  验证失败  │
             └─────┬─────┘                         └─────┬─────┘
                   │                                     │
                   ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ 生成JWT   │                         │ 返回错误   │
             │ Token     │                         │ 提示重试   │
             └─────┬─────┘                         └───────────┘
                   │
                   ▼
             ┌───────────┐
             │ 检查用户   │
             │ 状态      │
             └─────┬─────┘
                   │
        ┌──────────┴──────────┐
        │                     │
        ▼                     ▼
  ┌───────────┐         ┌───────────┐
  │ 状态正常   │         │ 状态禁用   │
  │ 登录成功   │         │ 拒绝登录   │
  └───────────┘         └───────────┘
```

---

## 三、店铺授权流程

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    店铺授权流程                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │  店主点击授权    │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  生成授权URL     │
                              │  (含partner_id) │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  跳转Shopee     │
                              │  授权页面       │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                     │
                    ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │  用户同意  │                         │  用户拒绝  │
             │  授权      │                         │  授权      │
             └─────┬─────┘                         └─────┬─────┘
                   │                                     │
                   ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ Shopee回调 │                         │ 返回错误   │
             │ 携带code   │                         │ 页面      │
             └─────┬─────┘                         └───────────┘
                   │
                   ▼
             ┌───────────┐
             │ 用code换取 │
             │ access_   │
             │ token     │
             └─────┬─────┘
                   │
        ┌──────────┴──────────┐
        │                     │
        ▼                     ▼
  ┌───────────┐         ┌───────────┐
  │ 换取成功   │         │ 换取失败   │
  └─────┬─────┘         └─────┬─────┘
        │                     │
        ▼                     ▼
  ┌───────────┐         ┌───────────┐
  │ 获取店铺   │         │ 记录错误   │
  │ 信息      │         │ 提示重试   │
  └─────┬─────┘         └───────────┘
        │
        ▼
  ┌───────────┐
  │ 保存店铺   │
  │ 和Token   │
  └─────┬─────┘
        │
        ▼
  ┌───────────┐
  │ 授权成功   │
  │ 跳转店铺   │
  │ 列表页    │
  └───────────┘
```

---

## 四、订单同步流程

### 4.1 同步策略说明

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    订单同步策略                                          │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  【主要方式】Webhook 实时推送                                                            │
│  ────────────────────────────                                                           │
│  • Shopee 主动推送订单状态变更                                                           │
│  • 实时性高，无需轮询                                                                    │
│  • 覆盖 95%+ 的订单状态更新                                                              │
│                                                                                         │
│  【辅助方式】增量定时同步 (补漏)                                                          │
│  ────────────────────────────                                                           │
│  • 只拉取 last_sync_time 之后的新订单                                                    │
│  • 用于补漏 Webhook 可能丢失的订单                                                       │
│  • 首次授权时全量同步历史订单                                                            │
│                                                                                         │
│  【性能考量】                                                                            │
│  ────────────────────────────                                                           │
│  • 5000店铺 × 7天 × 200单 = 700万单 (全量不可行)                                         │
│  • Shopee API 限流: 5 QPS/店铺                                                          │
│  • 增量同步: 只拉取新增订单，大幅减少 API 调用                                            │
│  • 多 Worker 并发: 10个 Worker 并行处理不同店铺                                          │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 分布式同步架构 (多服务器)

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              分布式同步架构 (3台服务器示例)                                │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │     Redis       │
                              │  (分布式协调)    │
                              └────────┬────────┘
                                       │
        ┌──────────────────────────────┼──────────────────────────────┐
        │                              │                              │
        ▼                              ▼                              ▼
┌───────────────┐              ┌───────────────┐              ┌───────────────┐
│   Server 1    │              │   Server 2    │              │   Server 3    │
│   (Worker)    │              │   (Worker)    │              │   (Worker)    │
└───────┬───────┘              └───────┬───────┘              └───────┬───────┘
        │                              │                              │
        ▼                              ▼                              ▼
┌───────────────┐              ┌───────────────┐              ┌───────────────┐
│ 抢占任务队列   │              │ 抢占任务队列   │              │ 抢占任务队列   │
│ 处理店铺      │              │ 处理店铺      │              │ 处理店铺      │
│ 1,4,7,10...  │              │ 2,5,8,11...  │              │ 3,6,9,12...  │
└───────────────┘              └───────────────┘              └───────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    核心组件                                              │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  【Redis 任务队列】                                                                       │
│  ────────────────────────────                                                           │
│  • sync:shop:queue (List)     - 待同步店铺ID队列                                         │
│  • sync:shop:processing (Set) - 正在处理的店铺ID                                         │
│  • sync:shop:lock:{shop_id}   - 店铺级别分布式锁                                         │
│                                                                                         │
│  【调度器 (单点/主节点)】                                                                 │
│  ────────────────────────────                                                           │
│  • 每30分钟将所有待同步店铺ID推入队列                                                     │
│  • 使用 Redis 分布式锁保证只有一个调度器在运行                                             │
│                                                                                         │
│  【Worker (多节点)】                                                                     │
│  ────────────────────────────                                                           │
│  • 从队列中抢占任务 (BRPOP)                                                              │
│  • 获取店铺锁后执行同步                                                                  │
│  • 同步完成后释放锁                                                                      │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    任务分配流程                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │  调度器触发      │
                              │  (每30分钟)     │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  尝试获取       │
                              │  调度器锁       │
                              │ sync:scheduler │
                              │ :lock          │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                     │
                    ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ 获取成功   │                         │ 获取失败   │
             │ (我是主)   │                         │ (其他节点) │
             └─────┬─────┘                         └─────┬─────┘
                   │                                     │
                   ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ 查询所有   │                         │ 跳过调度   │
             │ 待同步店铺 │                         │ 等待下次   │
             └─────┬─────┘                         └───────────┘
                   │
                   ▼
             ┌───────────┐
             │ 推入Redis │
             │ 任务队列   │
             │ LPUSH     │
             └─────┬─────┘
                   │
                   ▼
             ┌───────────┐
             │ 释放调度锁 │
             └───────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    Worker 处理流程                                       │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │  Worker 启动    │
                              │  (每台服务器)   │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  BRPOP 阻塞     │
                              │  等待任务       │
                              │  (超时30秒)     │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                     │
                    ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ 获取到任务 │                         │ 超时      │
             │ shop_id   │                         │ 继续等待   │
             └─────┬─────┘                         └─────┬─────┘
                   │                                     │
                   ▼                                     │
             ┌───────────┐                               │
             │ 尝试获取   │                               │
             │ 店铺锁     │                               │
             │ SETNX     │                               │
             └─────┬─────┘                               │
                   │                                     │
        ┌──────────┴──────────┐                          │
        │                     │                          │
        ▼                     ▼                          │
  ┌───────────┐         ┌───────────┐                    │
  │ 获取成功   │         │ 获取失败   │                    │
  │ (我来处理) │         │ (其他在处理)│                    │
  └─────┬─────┘         └─────┬─────┘                    │
        │                     │                          │
        ▼                     └──────────────────────────┤
  ┌───────────┐                                          │
  │ 执行增量   │                                          │
  │ 同步      │                                          │
  └─────┬─────┘                                          │
        │                                                │
        ▼                                                │
  ┌───────────┐                                          │
  │ 释放店铺锁 │                                          │
  └─────┬─────┘                                          │
        │                                                │
        └────────────────────────────────────────────────┘
```

### 4.3 增量定时同步流程 (补漏)

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              增量定时同步流程 (每30分钟)                                  │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │  定时器触发      │
                              │  (每30分钟)     │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  获取所有已授权  │
                              │  店铺列表       │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  分配给多个     │
                              │  Worker并发处理 │
                              │  (10个Worker)  │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                     │
                    ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ 启用同步   │                         │ 未启用同步 │
             └─────┬─────┘                         └─────┬─────┘
                   │                                     │
                   ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ 获取店铺   │                         │ 跳过      │
             │last_sync  │                         └───────────┘
             │_time      │
             └─────┬─────┘
                   │
                   ▼
             ┌───────────────────────────────────────────────┐
             │  增量拉取: time_from = last_sync_time          │
             │           time_to   = now()                   │
             │  (只拉取上次同步后的新订单)                      │
             └─────────────────────┬─────────────────────────┘
                                   │
                                   ▼
                            ┌───────────┐
                            │ 调用Shopee│
                            │ 订单API   │
                            │ (限流5QPS)│
                            └─────┬─────┘
                                  │
                   ┌──────────────┴──────────────┐
                   │                             │
                   ▼                             ▼
            ┌───────────┐                 ┌───────────┐
            │ 有新订单   │                 │ 无新订单   │
            └─────┬─────┘                 └─────┬─────┘
                  │                             │
                  ▼                             │
            ┌───────────┐                       │
            │ 保存/更新  │                       │
            │ 订单数据   │                       │
            └─────┬─────┘                       │
                  │                             │
                  └──────────────┬──────────────┘
                                 │
                                 ▼
                           ┌───────────┐
                           │ 更新店铺   │
                           │last_sync  │
                           │_time=now()│
                           └───────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    Webhook推送流程                                       │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │  Shopee推送     │
                              │  Webhook事件    │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  验证签名       │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                     │
                    ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │  验证成功  │                         │  验证失败  │
             └─────┬─────┘                         └─────┬─────┘
                   │                                     │
                   ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ 去重检查   │                         │ 丢弃请求   │
             │ (Redis)   │                         │ 记录日志   │
             └─────┬─────┘                         └───────────┘
                   │
        ┌──────────┴──────────┐
        │                     │
        ▼                     ▼
  ┌───────────┐         ┌───────────┐
  │  首次处理  │         │  重复事件  │
  └─────┬─────┘         └─────┬─────┘
        │                     │
        ▼                     ▼
  ┌───────────┐         ┌───────────┐
  │ 获取订单锁 │         │ 忽略处理   │
  └─────┬─────┘         └───────────┘
        │
        ▼
  ┌───────────┐
  │ 解析事件   │
  │ 类型      │
  └─────┬─────┘
        │
        ├─────────────────┬─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
  ┌───────────┐     ┌───────────┐     ┌───────────┐
  │ 订单状态   │     │ 物流更新   │     │ 订单取消   │
  │ 更新(3)   │     │ (4)       │     │ (5)       │
  └─────┬─────┘     └─────┬─────┘     └─────┬─────┘
        │                 │                 │
        ▼                 ▼                 ▼
  ┌───────────┐     ┌───────────┐     ┌───────────┐
  │ 检查状态   │     │ 更新物流   │     │ 更新订单   │
  │ 转换合法性 │     │ 单号      │     │ 状态      │
  └─────┬─────┘     └───────────┘     └─────┬─────┘
        │                                   │
        ▼                                   ▼
  ┌───────────┐                       ┌───────────┐
  │ 更新订单   │                       │ 处理退款   │
  │ 状态      │                       │ (见退款流程)│
  └───────────┘                       └───────────┘
```

---

## 五、发货流程

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    店主自发货流程                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │  选择待发货订单  │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  获取发货参数    │
                              │  (物流选项)      │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  选择物流方式    │
                              │  填写取件信息    │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  调用Shopee     │
                              │  发货API        │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                     │
                    ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │  发货成功  │                         │  发货失败  │
             └─────┬─────┘                         └─────┬─────┘
                   │                                     │
                   ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ 更新订单   │                         │ 返回错误   │
             │ 状态=已发货│                         │ 信息      │
             └─────┬─────┘                         └───────────┘
                   │
                   ▼
             ┌───────────┐
             │ 异步获取   │
             │ 物流单号   │
             └───────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    运营代发货流程                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │  运营选择订单    │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  检查运营权限    │
                              │  (店铺关联)      │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                     │
                    ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │  有权限    │                         │  无权限    │
             └─────┬─────┘                         └─────┬─────┘
                   │                                     │
                   ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ 填写成本   │                         │ 返回错误   │
             │ • 商品成本 │                         │ 无权操作   │
             │ • 运费成本 │                         └───────────┘
             └─────┬─────┘
                   │
                   ▼
             ┌───────────┐
             │ 检查店主   │
             │ 预付款余额 │
             └─────┬─────┘
                   │
        ┌──────────┴──────────┐
        │                     │
        ▼                     ▼
  ┌───────────┐         ┌───────────┐
  │ 余额充足   │         │ 余额不足   │
  └─────┬─────┘         └─────┬─────┘
        │                     │
        ▼                     ▼
  ┌───────────┐         ┌───────────┐
  │ 冻结预付款 │         │ 返回错误   │
  │ (总成本)   │         │ 余额不足   │
  └─────┬─────┘         └───────────┘
        │
        ▼
  ┌───────────┐
  │ 转入托管   │
  │ 账户      │
  └─────┬─────┘
        │
        ▼
  ┌───────────┐
  │ 创建发货   │
  │ 记录      │
  └─────┬─────┘
        │
        ▼
  ┌───────────┐
  │ 调用Shopee│
  │ 发货API   │
  └─────┬─────┘
        │
        ├─────────────────────────────────┐
        │                                 │
        ▼                                 ▼
  ┌───────────┐                     ┌───────────┐
  │ 发货成功   │                     │ 发货失败   │
  └─────┬─────┘                     └─────┬─────┘
        │                                 │
        ▼                                 ▼
  ┌───────────┐                     ┌───────────┐
  │ 更新记录   │                     │ 解冻预付款 │
  │ 状态=已发货│                     │ 托管退回   │
  └─────┬─────┘                     └─────┬─────┘
        │                                 │
        ▼                                 ▼
  ┌───────────┐                     ┌───────────┐
  │ 异步获取   │                     │ 更新记录   │
  │ 物流单号   │                     │ 状态=失败  │
  └───────────┘                     └───────────┘
```

---

## 六、结算流程

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    订单结算完整流程                                       │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │  订单已发货      │
                              │  等待签收       │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  买家签收       │
                              │  订单完成       │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  Shopee结算     │
                              │  金额入账钱包    │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  定时同步       │
                              │  finance_incomes│
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  检测到         │
                              │  ESCROW_VERIFIED│
                              │  _ADD 记录      │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  查找发货记录    │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                     │
                    ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ 有发货记录  │                         │ 无发货记录 │
             │ (运营发货)  │                         │ (店主自发) │
             └─────┬─────┘                         └─────┬─────┘
                   │                                     │
                   ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ 执行结算   │                         │ 无需结算   │
             │ 流程      │                         │ (无分成)   │
             └─────┬─────┘                         └───────────┘
                   │
                   ▼
             ┌───────────┐
             │ 获取分成   │
             │ 配置      │
             └─────┬─────┘
                   │
                   ▼
             ┌───────────┐
             │ 计算利润   │
             │ profit =  │
             │ escrow -  │
             │ cost      │
             └─────┬─────┘
                   │
        ┌──────────┴──────────┐
        │                     │
        ▼                     ▼
  ┌───────────┐         ┌───────────┐
  │ 利润 > 0   │         │ 利润 <= 0  │
  └─────┬─────┘         └─────┬─────┘
        │                     │
        ▼                     ▼
  ┌───────────┐         ┌───────────┐
  │ 计算分成   │         │ 利润为0   │
  │ 平台5%    │         │ 无分成    │
  │ 运营45%   │         └─────┬─────┘
  │ 店主50%   │               │
  └─────┬─────┘               │
        │                     │
        └──────────┬──────────┘
                   │
                   ▼
             ┌───────────┐
             │ 执行资金   │
             │ 划转      │
             └─────┬─────┘
                   │
    ┌──────────────┼──────────────┬──────────────┐
    │              │              │              │
    ▼              ▼              ▼              ▼
┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐
│从托管   │   │运营账户│   │店主佣金│   │平台佣金│
│账户转出 │   │入账    │   │入账    │   │入账    │
│        │   │成本+   │   │店主    │   │平台    │
│        │   │分成    │   │分成    │   │分成    │
└────────┘   └────────┘   └────────┘   └────────┘
                   │
                   ▼
             ┌───────────┐
             │ 扣除店主   │
             │ 冻结金额   │
             └─────┬─────┘
                   │
                   ▼
             ┌───────────┐
             │ 创建结算   │
             │ 记录      │
             │ status=1  │
             └─────┬─────┘
                   │
                   ▼
             ┌───────────┐
             │ 更新发货   │
             │ 记录状态   │
             │ =已完成    │
             └───────────┘
```

---

## 七、订单取消与退款流程

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    订单取消流程                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │  收到取消事件    │
                              │  (Webhook)      │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  更新订单状态    │
                              │  =已取消        │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  查找发货记录    │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                     │
                    ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ 有发货记录  │                         │ 无发货记录 │
             └─────┬─────┘                         └─────┬─────┘
                   │                                     │
                   ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ 检查状态   │                         │ 无需处理   │
             └─────┬─────┘                         │ 流程结束   │
                   │                               └───────────┘
    ┌──────────────┼──────────────┬──────────────┐
    │              │              │              │
    ▼              ▼              ▼              ▼
┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐
│待发货   │   │已发货   │   │已完成   │   │已取消   │
│(0)     │   │(1)     │   │(2)     │   │(3)     │
└───┬────┘   └───┬────┘   └───┬────┘   └───┬────┘
    │            │            │            │
    ▼            ▼            ▼            ▼
┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐
│解冻预付│   │解冻预付│   │无法退款│   │已处理   │
│款      │   │款      │   │(已结算)│   │忽略    │
└───┬────┘   └───┬────┘   └────────┘   └────────┘
    │            │
    ▼            ▼
┌────────┐   ┌────────┐
│托管退回│   │托管退回│
└───┬────┘   └───┬────┘
    │            │
    └─────┬──────┘
          │
          ▼
    ┌───────────┐
    │ 更新发货   │
    │ 记录状态   │
    │ =已取消    │
    └───────────┘
```

---

## 八、提现流程

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    提现完整流程                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │  用户申请提现    │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  选择账户类型    │
                              └────────┬────────┘
                                       │
        ┌──────────────────────────────┼──────────────────────────────┐
        │                              │                              │
        ▼                              ▼                              ▼
  ┌───────────┐                 ┌───────────┐                 ┌───────────┐
  │ 运营账户   │                 │ 店主佣金   │                 │ 保证金    │
  │ (operator)│                 │(commission)│                 │ (deposit) │
  └─────┬─────┘                 └─────┬─────┘                 └─────┬─────┘
        │                             │                             │
        ▼                             ▼                             ▼
  ┌───────────┐                 ┌───────────┐                 ┌───────────┐
  │ 可提现=   │                 │ 可提现=   │                 │ 可提现=   │
  │ 全部余额   │                 │ 全部余额   │                 │ 余额-15000│
  └─────┬─────┘                 └─────┬─────┘                 └─────┬─────┘
        │                             │                             │
        └──────────────┬──────────────┴──────────────┬──────────────┘
                       │                             │
                       ▼                             ▼
                 ┌───────────┐                 ┌───────────┐
                 │ 余额充足   │                 │ 余额不足   │
                 └─────┬─────┘                 └─────┬─────┘
                       │                             │
                       ▼                             ▼
                 ┌───────────┐                 ┌───────────┐
                 │ 选择收款   │                 │ 返回错误   │
                 │ 账户      │                 │ 余额不足   │
                 └─────┬─────┘                 └───────────┘
                       │
                       ▼
                 ┌───────────┐
                 │ 冻结提现   │
                 │ 金额      │
                 └─────┬─────┘
                       │
                       ▼
                 ┌───────────┐
                 │ 创建提现   │
                 │ 申请      │
                 │ status=0  │
                 └─────┬─────┘
                       │
                       ▼
                 ┌───────────┐
                 │ 等待平台   │
                 │ 审核      │
                 └─────┬─────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        ▼              ▼              ▼
  ┌───────────┐  ┌───────────┐  ┌───────────┐
  │ 审核通过   │  │ 审核拒绝   │  │ 长时间    │
  │ status=1  │  │ status=2  │  │ 未处理    │
  └─────┬─────┘  └─────┬─────┘  └───────────┘
        │              │
        ▼              ▼
  ┌───────────┐  ┌───────────┐
  │ 等待打款   │  │ 解冻金额   │
  └─────┬─────┘  │ 退回账户   │
        │        └───────────┘
        ▼
  ┌───────────┐
  │ 线下打款   │
  └─────┬─────┘
        │
        ▼
  ┌───────────┐
  │ 确认打款   │
  │ status=3  │
  └─────┬─────┘
        │
        ▼
  ┌───────────┐
  │ 扣除冻结   │
  │ 金额      │
  └─────┬─────┘
        │
        ▼
  ┌───────────┐
  │ 更新累计   │
  │ 提现金额   │
  └─────┬─────┘
        │
        ▼
  ┌───────────┐
  │ 记录流水   │
  │ 提现完成   │
  └───────────┘
```

---

## 九、充值流程

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    充值完整流程                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │  用户申请充值    │
                              │  (线下转账)      │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  选择账户类型    │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                     │
                    ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ 预付款账户  │                         │ 保证金账户 │
             │(prepayment)│                         │ (deposit) │
             └─────┬─────┘                         └─────┬─────┘
                   │                                     │
                   └──────────────┬───────────────────────┘
                                  │
                                  ▼
                            ┌───────────┐
                            │ 输入金额   │
                            └─────┬─────┘
                                  │
                                  ▼
                            ┌───────────┐
                            │ 选择支付   │
                            │ 方式      │
                            └─────┬─────┘
                                  │
                   ┌──────────────┴──────────────┐
                   │                             │
                   ▼                             ▼
            ┌───────────┐                 ┌───────────┐
            │ 银行转账   │                 │ 现金      │
            │bank_trans │                 │ cash     │
            └─────┬─────┘                 └─────┬─────┘
                  │                             │
                  └──────────────┬──────────────┘
                                 │
                                 ▼
                           ┌───────────┐
                           │ 上传转账   │
                           │ 凭证      │
                           └─────┬─────┘
                                 │
                                 ▼
                           ┌───────────┐
                           │ 创建充值   │
                           │ 申请      │
                           │ status=0  │
                           └─────┬─────┘
                                 │
                                 ▼
                           ┌───────────┐
                           │ 等待平台   │
                           │ 审核      │
                           └─────┬─────┘
                                 │
                  ┌──────────────┴──────────────┐
                  │                             │
                  ▼                             ▼
           ┌───────────┐                 ┌───────────┐
           │ 审核通过   │                 │ 审核拒绝   │
           │ status=1  │                 │ status=2  │
           └─────┬─────┘                 └─────┬─────┘
                 │                             │
                 ▼                             ▼
           ┌───────────┐                 ┌───────────┐
           │ 执行充值   │                 │ 记录拒绝   │
           │ 入账      │                 │ 原因      │
           └─────┬─────┘                 └───────────┘
                 │
                 ▼
           ┌───────────┐
           │ 更新账户   │
           │ 余额      │
           └─────┬─────┘
                 │
                 ▼
           ┌───────────┐
           │ 记录流水   │
           │ 充值完成   │
           └───────────┘
```

---

## 十、合作关系管理流程

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    合作关系管理流程                                       │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │  平台创建合作    │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  选择店铺       │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  选择运营       │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  检查是否已有    │
                              │  合作关系       │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                     │
                    ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ 无现有合作  │                         │ 已有合作   │
             └─────┬─────┘                         └─────┬─────┘
                   │                                     │
                   ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ 设置分成   │                         │ 返回错误   │
             │ 比例      │                         │ 已存在    │
             └─────┬─────┘                         └───────────┘
                   │
                   ▼
             ┌───────────┐
             │ 验证比例   │
             │ 总和=100% │
             └─────┬─────┘
                   │
        ┌──────────┴──────────┐
        │                     │
        ▼                     ▼
  ┌───────────┐         ┌───────────┐
  │ 验证通过   │         │ 验证失败   │
  └─────┬─────┘         └─────┬─────┘
        │                     │
        ▼                     ▼
  ┌───────────┐         ┌───────────┐
  │ 创建合作   │         │ 返回错误   │
  │ 关系记录   │         │ 比例不对   │
  └─────┬─────┘         └───────────┘
        │
        ▼
  ┌───────────┐
  │ 创建分成   │
  │ 配置记录   │
  └─────┬─────┘
        │
        ▼
  ┌───────────┐
  │ 合作关系   │
  │ 生效      │
  └───────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    取消合作关系                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │  平台取消合作    │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  检查待结算     │
                              │  订单          │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                     │
                    ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ 有待结算   │                         │ 无待结算   │
             │ 订单      │                         │ 订单      │
             └─────┬─────┘                         └─────┬─────┘
                   │                                     │
                   ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ 提示先完成 │                         │ 更新状态   │
             │ 结算      │                         │ =失效     │
             └───────────┘                         └─────┬─────┘
                                                        │
                                                        ▼
                                                  ┌───────────┐
                                                  │ 更新分成   │
                                                  │ 配置失效   │
                                                  └───────────┘
```

---

## 十一、状态机汇总

### 11.1 订单状态

```
                              ┌─────────────┐
                              │   UNPAID    │
                              │   未付款    │
                              └──────┬──────┘
                                     │ 付款
                                     ▼
                              ┌─────────────┐
                              │READY_TO_SHIP│◄────────────┐
                              │   待发货    │             │
                              └──────┬──────┘             │
                                     │                    │
                    ┌────────────────┼────────────────┐   │
                    │ 发货           │ 取消           │   │
                    ▼                ▼                │   │
             ┌─────────────┐  ┌─────────────┐        │   │
             │   SHIPPED   │  │  CANCELLED  │        │   │
             │   已发货    │  │   已取消    │        │   │
             └──────┬──────┘  └─────────────┘        │   │
                    │                                │   │
         ┌──────────┼──────────┐                     │   │
         │ 签收     │ 退货     │ 取消                │   │
         ▼          ▼          ▼                     │   │
  ┌───────────┐ ┌───────────┐ ┌───────────┐         │   │
  │ COMPLETED │ │ TO_RETURN │ │ IN_CANCEL │─────────┘   │
  │  已完成   │ │  待退货   │ │  取消中   │             │
  └───────────┘ └─────┬─────┘ └───────────┘             │
                      │ 退货完成                        │
                      └─────────────────────────────────┘
```

### 11.2 发货记录状态

```
  ┌───────────┐
  │  待发货   │
  │   (0)    │
  └─────┬─────┘
        │
        ├─────────────────┬─────────────────┐
        │ 发货成功        │ 发货失败        │
        ▼                 ▼                 │
  ┌───────────┐     ┌───────────┐          │
  │  已发货   │     │  发货失败  │          │
  │   (1)    │     │   (4)     │          │
  └─────┬─────┘     └───────────┘          │
        │                                   │
        ├─────────────────┐                 │
        │ 结算完成        │ 订单取消        │
        ▼                 ▼                 │
  ┌───────────┐     ┌───────────┐          │
  │  已完成   │     │  已取消   │◄─────────┘
  │   (2)    │     │   (3)    │
  └───────────┘     └───────────┘
```

### 11.3 结算状态

```
  ┌───────────┐
  │  待结算   │
  │   (0)    │
  └─────┬─────┘
        │
        ├─────────────────┐
        │ 结算成功        │ 订单取消
        ▼                 ▼
  ┌───────────┐     ┌───────────┐
  │  已结算   │     │  已取消   │
  │   (1)    │     │   (2)    │
  └───────────┘     └───────────┘
```

### 11.4 提现/充值申请状态

```
  ┌───────────┐
  │  待审核   │
  │   (0)    │
  └─────┬─────┘
        │
        ├─────────────────┐
        │ 审核通过        │ 审核拒绝
        ▼                 ▼
  ┌───────────┐     ┌───────────┐
  │  已通过   │     │  已拒绝   │
  │   (1)    │     │   (2)    │
  └─────┬─────┘     └───────────┘
        │
        │ 确认打款 (仅提现)
        ▼
  ┌───────────┐
  │  已打款   │
  │   (3)    │
  └───────────┘
```

---

## 十二、异常处理流程

### 12.1 Token 过期处理

```
                              ┌─────────────────┐
                              │  调用Shopee API  │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  检查响应       │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                     │
                    ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │  调用成功  │                         │ Token过期  │
             │           │                         │ 错误码    │
             └───────────┘                         └─────┬─────┘
                                                        │
                                                        ▼
                                                  ┌───────────┐
                                                  │ 尝试刷新   │
                                                  │ Token     │
                                                  └─────┬─────┘
                                                        │
                                         ┌──────────────┴──────────────┐
                                         │                             │
                                         ▼                             ▼
                                  ┌───────────┐                 ┌───────────┐
                                  │ 刷新成功   │                 │ 刷新失败   │
                                  └─────┬─────┘                 └─────┬─────┘
                                        │                             │
                                        ▼                             ▼
                                  ┌───────────┐                 ┌───────────┐
                                  │ 重试原请求 │                 │ 标记店铺   │
                                  │           │                 │ 需重新授权 │
                                  └───────────┘                 └───────────┘
```

### 12.2 并发冲突处理

```
                              ┌─────────────────┐
                              │  操作订单/账户   │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  获取分布式锁    │
                              │  (Redis)        │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                     │
                    ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │  获取成功  │                         │  获取失败  │
             └─────┬─────┘                         └─────┬─────┘
                   │                                     │
                   ▼                                     ▼
             ┌───────────┐                         ┌───────────┐
             │ 执行业务   │                         │ 等待重试   │
             │ 逻辑      │                         │ 或返回错误 │
             └─────┬─────┘                         └───────────┘
                   │
                   ▼
             ┌───────────┐
             │ 释放锁     │
             └───────────┘
```

---

## 十三、定时任务流程

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    定时任务调度                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │  调度器启动      │
                              └────────┬────────┘
                                       │
           ┌───────────────────────────┼───────────────────────────┐
           │                           │                           │
           ▼                           ▼                           ▼
    ┌─────────────┐            ┌─────────────┐            ┌─────────────┐
    │  每5分钟     │            │  每小时      │            │  每天       │
    │  财务同步    │            │  统计打印    │            │  数据清理   │
    └──────┬──────┘            └──────┬──────┘            └──────┬──────┘
           │                          │                          │
           ▼                          ▼                          ▼
    ┌─────────────┐            ┌─────────────┐            ┌─────────────┐
    │ 遍历所有     │            │ 打印同步     │            │ 清理过期    │
    │ 启用店铺     │            │ 统计信息     │            │ 缓存/日志   │
    └──────┬──────┘            └─────────────┘            └─────────────┘
           │
           ▼
    ┌─────────────┐
    │ 10个Worker  │
    │ 并发处理    │
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │ 增量同步     │
    │ 钱包交易     │
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │ 检测已结算   │
    │ 订单        │
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │ 触发内部     │
    │ 结算流程     │
    └─────────────┘
```
