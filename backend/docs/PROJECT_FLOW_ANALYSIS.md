# Balance 项目流程分析报告

## 一、项目概述

Balance 是一个 **Shopee 店铺管理平台**，主要功能包括：
- 店铺授权与管理
- 订单同步与管理
- 发货管理
- 财务结算与账单管理

### 技术栈

| 层级 | 技术 |
|------|------|
| 后端 | Go + Gin + GORM + MySQL + Redis |
| 前端 | Vue 3 + TypeScript + Element Plus |
| 外部API | Shopee Open Platform API |

### 用户角色

| 角色 | userType | 说明 |
|------|----------|------|
| 店主 (shopower) | 1 | 管理自己的店铺、订单、发货、财务 |
| 运营 (operator) | 5 | 查看所有店铺和订单（只读） |
| 平台 (platform) | 9 | 管理用户、店铺、同步状态 |

---

## 二、核心数据模型

### 2.1 订单相关

```
┌─────────────────────────────────────────────────────────────┐
│                         orders                               │
│  订单主表 - 存储从 Shopee 同步的订单基本信息                    │
├─────────────────────────────────────────────────────────────┤
│ id, shop_id, order_sn, order_status, total_amount, ...      │
└─────────────────────────────────────────────────────────────┘
         │ 1:N                              │ 1:1
         ▼                                  ▼
┌─────────────────────┐          ┌─────────────────────┐
│    order_items      │          │   order_addresses   │
│   订单商品明细       │          │    订单收货地址      │
└─────────────────────┘          └─────────────────────┘
```

**代码位置**: `internal/models/order.go`

### 2.2 结算相关 (账单核心)

```
┌─────────────────────────────────────────────────────────────┐
│                      order_escrows                           │
│  订单结算明细 - 每个订单的详细结算信息（佣金、运费、折扣等）     │
├─────────────────────────────────────────────────────────────┤
│ escrow_amount (最终结算金额)                                  │
│ commission_fee (平台佣金)                                     │
│ service_fee (服务费)                                          │
│ seller_discount (卖家折扣)                                    │
│ shopee_discount (平台折扣)                                    │
│ actual_shipping_fee (实际运费)                                │
│ ... 30+ 个结算相关字段                                        │
└─────────────────────────────────────────────────────────────┘
         │ 1:N
         ▼
┌─────────────────────────────────────────────────────────────┐
│                   order_escrow_items                         │
│  订单结算商品明细 - 每个商品的折扣、优惠券抵扣等                │
└─────────────────────────────────────────────────────────────┘
```

**代码位置**: `internal/models/order_escrow.go`

### 2.3 财务收入 (钱包交易流水)

```
┌─────────────────────────────────────────────────────────────┐
│                     finance_incomes                          │
│  钱包交易记录 - 从 Shopee 钱包 API 同步的所有交易流水          │
├─────────────────────────────────────────────────────────────┤
│ transaction_type:                                            │
│   - ESCROW_VERIFIED_ADD  → 订单结算收入                       │
│   - WITHDRAWAL_CREATED   → 提现创建                           │
│   - WITHDRAWAL_COMPLETED → 提现完成                           │
│   - REFUND               → 退款                               │
│ amount, order_sn, settlement_handle_status, ...              │
└─────────────────────────────────────────────────────────────┘
```

**代码位置**: `internal/models/finance_income.go`

### 2.4 模型关系图

```
                    ┌──────────────┐
                    │    shops     │
                    │   店铺信息    │
                    └──────┬───────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
           ▼               ▼               ▼
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │   orders     │ │finance_incomes│ │shop_sync_    │
    │   订单       │ │  财务流水     │ │  records     │
    └──────┬───────┘ └──────────────┘ │  同步记录    │
           │                          └──────────────┘
           │
    ┌──────┴───────┐
    │              │
    ▼              ▼
┌──────────┐ ┌──────────────┐
│order_    │ │order_escrows │
│items     │ │  结算明细     │
└──────────┘ └──────────────┘
```

---

## 三、订单流程

### 3.1 订单数据来源

订单数据有 **两种来源**：

#### 方式1: 主动同步 (用户触发)

```
用户点击"同步订单"
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│ 前端: Orders.vue → orderApi.syncOrders()                     │
│ 路由: POST /api/v1/balance/admin/shopower/orders/sync        │
└─────────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│ Handler: admin/internal/handlers/shopower/order_handler.go   │
│ 方法: SyncOrders()                                           │
└─────────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│ Service: internal/services/shopower/order_service.go         │
│ 方法: SyncOrders() → syncOrdersInRange()                     │
│ 功能:                                                        │
│   1. 获取同步锁 (Redis)                                       │
│   2. 分时间段调用 Shopee API (每段最多15天)                    │
│   3. 限流控制 (每店铺 5 QPS)                                  │
│   4. 保存/更新订单到数据库                                    │
└─────────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│ Shopee Client: internal/shopee/client.go                     │
│ API: /api/v2/order/get_order_list                            │
│ API: /api/v2/order/get_order_detail                          │
└─────────────────────────────────────────────────────────────┘
```

#### 方式2: Webhook 推送 (Shopee 主动推送)

```
Shopee 订单状态变更
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│ 路由: POST /webhook/shopee                                   │
│ Handler: admin/internal/handlers/webhook_handler.go          │
└─────────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│ Service: internal/services/webhook_service.go                │
│ 方法: HandleOrderStatusUpdate()                              │
│ 功能:                                                        │
│   1. 去重检查 (Redis)                                        │
│   2. 获取订单锁                                               │
│   3. 检查更新时间 (防止旧数据覆盖新数据)                       │
│   4. 状态转换校验 (防止状态回滚)                              │
│   5. 更新订单状态                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 订单状态流转

```
UNPAID (未付款)
    │
    ▼
READY_TO_SHIP (待发货) ←─────────────────┐
    │                                    │
    ├──────────────────┐                 │
    ▼                  ▼                 │
SHIPPED (已发货)   CANCELLED (已取消)    │
    │                                    │
    ▼                                    │
COMPLETED (已完成) ──────────────────────┘
    │                    (退货退款)
    ▼
结算流程开始
```

### 3.3 订单相关代码文件

| 文件 | 说明 |
|------|------|
| `internal/models/order.go` | 订单数据模型 |
| `internal/services/shopower/order_service.go` | 订单业务逻辑 |
| `admin/internal/handlers/shopower/order_handler.go` | 订单 API 处理器 |
| `internal/services/webhook_service.go` | Webhook 处理 |
| `internal/shopee/client.go` | Shopee API 客户端 |
| `frontend/admin/share/api/order.ts` | 前端订单 API |
| `frontend/admin/shopower/views/Orders.vue` | 订单列表页面 |

---

## 四、账单/财务流程

### 4.1 账单数据来源

账单数据有 **两种 API**：

#### API 1: get_escrow_detail (单订单结算明细)

```
用途: 获取单个订单的详细结算信息
触发: 订单完成后，按需获取
```

```
┌─────────────────────────────────────────────────────────────┐
│ 路由: POST /shopower/escrows/:shop_id/:order_sn/sync         │
│ Handler: admin/internal/handlers/shopower/escrow_handler.go  │
└─────────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│ Service: internal/services/shopower/escrow_service.go        │
│ 方法: SyncOrderEscrow() → fetchAndSaveEscrow()               │
└─────────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│ Shopee API: /api/v2/payment/get_escrow_detail                │
│ 返回: 订单的完整结算明细 (30+ 字段)                           │
└─────────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│ 数据库: order_escrows + order_escrow_items                   │
└─────────────────────────────────────────────────────────────┘
```

#### API 2: get_wallet_transaction_list (批量钱包流水)

```
用途: 批量获取店铺的所有钱包交易记录
触发: 定时任务自动同步 (每5分钟)
```

```
┌─────────────────────────────────────────────────────────────┐
│ 定时调度: internal/services/sync/scheduler.go                │
│ 每5分钟触发一次                                              │
└─────────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│ Service: internal/services/sync/finance_sync_service.go      │
│ 功能:                                                        │
│   1. 遍历所有启用的店铺                                       │
│   2. 增量同步 (只拉取上次同步后的新数据)                       │
│   3. 10个 Worker 并发处理                                    │
│   4. 每店铺独立限流 (5 QPS)                                   │
└─────────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│ Shopee API: /api/v2/payment/get_wallet_transaction_list      │
│ 返回: 交易流水列表 (每页100条)                                │
└─────────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│ 数据库: finance_incomes                                      │
│ 记录: transaction_id, order_sn, amount, transaction_type     │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 两种 API 的区别

| 特性 | get_escrow_detail | get_wallet_transaction_list |
|------|-------------------|----------------------------|
| 粒度 | 单订单 | 批量 (100条/页) |
| 数据 | 详细结算明细 (30+字段) | 交易流水 (金额、类型) |
| 用途 | 查看订单结算详情 | 统计收入、对账 |
| 调用时机 | 按需 | 定时批量 |
| 存储表 | order_escrows | finance_incomes |

### 4.3 账单计算逻辑

```
订单结算金额 (escrow_amount) =
    商品原价 (original_price)
  - 卖家折扣 (seller_discount)
  - 平台折扣 (shopee_discount)
  - 优惠券 (voucher_from_seller + voucher_from_shopee)
  - 虾皮币 (coins)
  + 买家运费 (buyer_paid_shipping_fee)
  - 平台佣金 (commission_fee)
  - 服务费 (service_fee)
  - 交易手续费 (seller_transaction_fee)
  - 运费 (actual_shipping_fee)
  + 各种补贴 (payment_promotion, seller_lost_compensation, ...)
```

### 4.4 账单相关代码文件

| 文件 | 说明 |
|------|------|
| `internal/models/order_escrow.go` | 订单结算明细模型 |
| `internal/models/finance_income.go` | 财务收入模型 |
| `internal/services/shopower/escrow_service.go` | 结算明细服务 |
| `internal/services/shopower/finance_service.go` | 财务收入服务 |
| `internal/services/sync/finance_sync_service.go` | 财务增量同步服务 |
| `internal/services/sync/scheduler.go` | 同步调度器 |
| `admin/internal/handlers/shopower/escrow_handler.go` | 结算 API 处理器 |
| `admin/internal/handlers/shopower/finance_handler.go` | 财务 API 处理器 |
| `frontend/admin/shopower/views/Finance.vue` | 财务总览页面 |

---

## 五、完整业务流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              店主操作流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

1. 店铺授权
   ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
   │ 点击授权  │ ──▶ │ 跳转Shopee│ ──▶ │ 授权回调  │ ──▶ │ 保存Token │
   └──────────┘     └──────────┘     └──────────┘     └──────────┘
   
2. 订单同步
   ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
   │ 同步订单  │ ──▶ │ 调用API   │ ──▶ │ 保存订单  │ ──▶ │ 显示列表  │
   └──────────┘     └──────────┘     └──────────┘     └──────────┘
        │
        │ (后续自动)
        ▼
   ┌──────────┐
   │ Webhook  │ ──▶ 实时更新订单状态
   └──────────┘

3. 发货处理
   ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
   │ 待发货订单│ ──▶ │ 选择物流  │ ──▶ │ 调用发货  │ ──▶ │ 更新状态  │
   └──────────┘     └──────────┘     └──────────┘     └──────────┘

4. 财务结算
   ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
   │ 订单完成  │ ──▶ │ 定时同步  │ ──▶ │ 拉取流水  │ ──▶ │ 显示账单  │
   └──────────┘     └──────────┘     └──────────┘     └──────────┘
        │                                  │
        │ (按需)                           │ (批量)
        ▼                                  ▼
   ┌──────────┐                      ┌──────────┐
   │get_escrow│                      │get_wallet│
   │_detail   │                      │_trans... │
   └──────────┘                      └──────────┘
```

---

## 六、API 路由总览

### 6.1 店主路由 (/api/v1/balance/admin/shopower)

| 方法 | 路径 | 说明 |
|------|------|------|
| **店铺** | | |
| GET | /shops/auth-url | 获取授权URL |
| GET | /shops | 店铺列表 |
| GET | /shops/:shop_id | 店铺详情 |
| POST | /shops/bind | 绑定店铺 |
| **订单** | | |
| POST | /orders/sync | 同步订单 |
| GET | /orders | 订单列表 |
| GET | /orders/ready-to-ship | 待发货订单 |
| GET | /orders/:shop_id/:order_sn | 订单详情 |
| **发货** | | |
| POST | /shipments/ship | 发货 |
| POST | /shipments/batch-ship | 批量发货 |
| GET | /shipments/shipping-parameter | 发货参数 |
| **结算** | | |
| GET | /escrows | 待同步结算订单 |
| POST | /escrows/:shop_id/:order_sn/sync | 同步结算明细 |
| GET | /escrows/:shop_id/:order_sn | 获取结算明细 |
| **财务** | | |
| GET | /finances | 财务收入列表 |
| POST | /finances/:shop_id/sync | 同步钱包交易 |
| GET | /finances/:shop_id/stats | 收入统计 |

### 6.2 平台路由 (/api/v1/balance/admin/platform)

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /sync/stats | 同步统计 |
| GET | /sync/records | 同步记录列表 |
| POST | /sync/records/:shop_id/reset | 重置同步状态 |

---

## 七、定时任务

| 任务 | 周期 | 说明 | 代码位置 |
|------|------|------|----------|
| 财务同步 | 每5分钟 | 增量同步所有店铺的钱包交易 | `sync/scheduler.go` |
| 统计打印 | 每小时 | 打印同步统计信息 | `sync/scheduler.go` |

---

## 八、关键设计点

### 8.1 限流控制

```go
// 每个店铺独立限流器，5 QPS
limiter := rate.NewLimiter(5, 10)
```

### 8.2 增量同步

```go
// 记录上次同步时间，只拉取新数据
if tx.CreateTime <= record.LastSyncTime {
    continue
}
```

### 8.3 Webhook 去重

```go
// Redis 去重，防止重复处理
dedupKey := fmt.Sprintf("webhook:dedup:%d:%s:%d:%d", shopID, orderSN, code, timestamp)
```

### 8.4 状态回滚保护

```go
// 防止旧状态覆盖新状态
if newPriority < currentPriority {
    return false // 拒绝回滚
}
```

---

## 九、前端页面结构

```
frontend/admin/
├── share/                    # 共享代码
│   ├── api/
│   │   ├── auth.ts          # 认证 API
│   │   ├── order.ts         # 订单 API
│   │   └── shopee.ts        # Shopee 相关 API
│   ├── constants/
│   │   └── code.ts          # 错误码
│   └── utils/
│       └── request.ts       # HTTP 请求封装
│
├── shopower/                 # 店主模块
│   └── views/
│       ├── Home.vue         # 首页
│       ├── Stores.vue       # 店铺管理
│       ├── Orders.vue       # 订单管理
│       ├── Finance.vue      # 财务总览
│       ├── FinanceAccount.vue      # 账户明细
│       ├── FinanceCommission.vue   # 佣金明细
│       ├── FinanceDeposit.vue      # 押金明细
│       └── FinancePrepayment.vue   # 预付款明细
│
├── operator/                 # 运营模块
│   └── views/
│       ├── Stores.vue       # 店铺查看
│       └── Orders.vue       # 订单查看
│
└── platform/                 # 平台模块
    └── views/
        └── ...              # 平台管理页面
```

---

## 十、账户体系

### 10.1 账户类型总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              账户体系架构                                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              店主账户                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐          │
│  │  预付款账户       │  │  保证金账户       │  │  佣金账户         │          │
│  │  prepayment      │  │  deposit         │  │  commission      │          │
│  ├──────────────────┤  ├──────────────────┤  ├──────────────────┤          │
│  │ • 可用余额        │  │ • 保证金余额      │  │ • 可用余额        │          │
│  │ • 冻结金额        │  │ • 应缴金额        │  │ • 冻结金额        │          │
│  │ • 累计充值        │  │ • 最低门槛15000   │  │ • 累计收益        │          │
│  │ • 累计消费        │  │                  │  │ • 累计提现        │          │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              运营账户                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐                                                       │
│  │  回款账户         │                                                       │
│  │  operator        │                                                       │
│  ├──────────────────┤                                                       │
│  │ • 可用余额        │  ← 结算时收到：成本 + 运营分成                          │
│  │ • 冻结金额        │                                                       │
│  │ • 累计收益        │                                                       │
│  │ • 累计提现        │                                                       │
│  └──────────────────┘                                                       │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              平台账户 (单例)                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐          │
│  │  平台佣金账户     │  │  罚补账户         │  │  托管账户         │          │
│  │  platform_comm   │  │  penalty_bonus   │  │  escrow          │          │
│  ├──────────────────┤  ├──────────────────┤  ├──────────────────┤          │
│  │ • 累计平台分成    │  │ • 罚款/补贴余额   │  │ • 托管余额        │          │
│  │ • 可提现余额      │  │ • 累计罚款        │  │ • 累计转入        │          │
│  │                  │  │ • 累计补贴        │  │ • 累计转出        │          │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 10.2 账户数据模型

| 账户类型 | 数据表 | 所属角色 | 说明 |
|----------|--------|----------|------|
| 预付款账户 | `prepayment_accounts` | 店主 | 发货时冻结，结算时扣除 |
| 保证金账户 | `deposit_accounts` | 店主 | 最低15000 TWD，超出可提现 |
| 店主佣金账户 | `shop_owner_commission_accounts` | 店主 | 结算时收到利润分成 |
| 运营账户 | `operator_accounts` | 运营 | 结算时收到成本+分成 |
| 平台佣金账户 | `platform_commission_accounts` | 平台 | 结算时收到平台分成 |
| 罚补账户 | `penalty_bonus_accounts` | 平台 | 罚款/补贴管理 |
| 托管账户 | `escrow_accounts` | 平台 | 临时托管发货冻结金额 |

### 10.3 账户流水

所有账户变动都记录在 `account_transactions` 表：

| 交易类型 | 常量 | 说明 |
|----------|------|------|
| 充值 | `recharge` | 预付款/保证金充值 |
| 提现 | `withdraw` | 佣金/保证金提现 |
| 冻结 | `freeze` | 发货时冻结预付款 |
| 解冻 | `unfreeze` | 订单取消时解冻 |
| 订单支付 | `order_pay` | 结算时扣除冻结金额 |
| 订单退款 | `order_refund` | 退款时返还 |
| 利润分成 | `profit_share` | 店主佣金入账 |
| 成本结算 | `cost_settle` | 运营收入入账 |
| 平台服务费 | `platform_fee` | 平台佣金入账 |
| 保证金缴纳 | `deposit_pay` | 保证金充值 |
| 保证金退还 | `deposit_refund` | 保证金提现 |

**代码位置**: `internal/models/account.go`, `internal/services/account_service.go`

---

## 十一、结算流程

### 11.1 利润分成配置

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           利润分成配置表                                     │
│                        profit_share_configs                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  shop_id          │ 店铺ID                                                  │
│  operator_id      │ 运营ID                                                  │
│  platform_share   │ 平台分成比例 (默认 5%)                                   │
│  operator_share   │ 运营分成比例 (默认 45%)                                  │
│  shop_owner_share │ 店主分成比例 (默认 50%)                                  │
└─────────────────────────────────────────────────────────────────────────────┘

利润 = Shopee结算金额 - 商品成本 - 运费成本
分成 = 利润 × 分成比例
```

### 11.2 结算流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              订单结算流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

1. 运营发货
   ┌──────────────────────────────────────────────────────────────────────────┐
   │  运营选择订单 → 填写成本 → 调用发货API                                     │
   │                    │                                                     │
   │                    ▼                                                     │
   │  ┌─────────────────────────────────────────────────────────────────┐    │
   │  │ 1. 检查店主预付款余额                                             │    │
   │  │ 2. 冻结预付款 (商品成本 + 运费成本)                                │    │
   │  │ 3. 转入托管账户                                                   │    │
   │  │ 4. 创建发货记录 (order_shipment_records)                         │    │
   │  │ 5. 调用 Shopee 发货 API                                          │    │
   │  └─────────────────────────────────────────────────────────────────┘    │
   └──────────────────────────────────────────────────────────────────────────┘

2. Shopee 结算 (订单完成后)
   ┌──────────────────────────────────────────────────────────────────────────┐
   │  Shopee 完成订单 → 钱包收到结算金额 → 同步到 finance_incomes              │
   └──────────────────────────────────────────────────────────────────────────┘

3. 平台结算 (定时任务或手动触发)
   ┌──────────────────────────────────────────────────────────────────────────┐
   │  检测到 Shopee 已结算 → 执行内部结算                                       │
   │                    │                                                     │
   │                    ▼                                                     │
   │  ┌─────────────────────────────────────────────────────────────────┐    │
   │  │ 1. 计算利润 = Shopee结算金额 - 总成本                             │    │
   │  │ 2. 计算各方分成                                                   │    │
   │  │    • 平台分成 = 利润 × 5%                                         │    │
   │  │    • 运营分成 = 利润 × 45%                                        │    │
   │  │    • 店主分成 = 利润 × 50%                                        │    │
   │  │ 3. 从托管账户转出                                                 │    │
   │  │ 4. 扣除店主冻结金额                                               │    │
   │  │ 5. 运营账户入账 (成本 + 运营分成)                                  │    │
   │  │ 6. 店主佣金账户入账 (店主分成)                                     │    │
   │  │ 7. 平台佣金账户入账 (平台分成)                                     │    │
   │  │ 8. 创建结算记录 (order_settlements)                               │    │
   │  └─────────────────────────────────────────────────────────────────┘    │
   └──────────────────────────────────────────────────────────────────────────┘
```

### 11.3 结算计算示例

```
假设:
  Shopee 结算金额 = 1000 TWD
  商品成本 = 300 TWD
  运费成本 = 100 TWD
  分成比例 = 平台5% / 运营45% / 店主50%

计算:
  总成本 = 300 + 100 = 400 TWD
  利润 = 1000 - 400 = 600 TWD
  
  平台分成 = 600 × 5% = 30 TWD
  运营分成 = 600 × 45% = 270 TWD
  店主分成 = 600 × 50% = 300 TWD
  
  运营实际收入 = 400 (成本) + 270 (分成) = 670 TWD
```

### 11.4 订单取消退款

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           订单取消退款流程                                   │
└─────────────────────────────────────────────────────────────────────────────┘

Shopee Webhook 推送订单取消
           │
           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. 查找发货记录 (order_shipment_records)                                     │
│ 2. 检查状态 (只处理已发货但未结算的订单)                                      │
│ 3. 解冻店主预付款                                                            │
│ 4. 从托管账户退回                                                            │
│ 5. 更新发货记录状态为"已取消"                                                │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 11.5 结算相关代码文件

| 文件 | 说明 |
|------|------|
| `internal/models/order_settlement.go` | 结算记录模型 |
| `internal/services/settlement_service.go` | 结算业务逻辑 |
| `internal/services/operator/shipment_service.go` | 运营发货服务 |
| `internal/services/webhook_service.go` | 订单取消处理 |
| `admin/internal/handlers/platform/settlement_handler.go` | 结算 API |

---

## 十二、提现与充值

### 12.1 提现流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              提现申请流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

1. 用户申请提现
   ┌──────────────────────────────────────────────────────────────────────────┐
   │  选择账户类型 → 输入金额 → 选择收款账户 → 提交申请                          │
   │                    │                                                     │
   │                    ▼                                                     │
   │  ┌─────────────────────────────────────────────────────────────────┐    │
   │  │ 1. 验证可提现余额                                                 │    │
   │  │    • 运营账户: 全部可用余额                                        │    │
   │  │    • 店主佣金: 全部可用余额                                        │    │
   │  │    • 保证金: 超出15000的部分                                       │    │
   │  │ 2. 冻结提现金额                                                   │    │
   │  │ 3. 创建提现申请 (withdraw_applications)                           │    │
   │  └─────────────────────────────────────────────────────────────────┘    │
   └──────────────────────────────────────────────────────────────────────────┘

2. 平台审核
   ┌──────────────────────────────────────────────────────────────────────────┐
   │  查看申请列表 → 审核通过/拒绝                                              │
   │                    │                                                     │
   │         ┌──────────┴──────────┐                                          │
   │         ▼                     ▼                                          │
   │  ┌─────────────┐       ┌─────────────┐                                   │
   │  │ 审核通过     │       │ 审核拒绝     │                                   │
   │  │ status = 1  │       │ status = 2  │                                   │
   │  │ 等待打款     │       │ 解冻金额     │                                   │
   │  └─────────────┘       └─────────────┘                                   │
   └──────────────────────────────────────────────────────────────────────────┘

3. 确认打款
   ┌──────────────────────────────────────────────────────────────────────────┐
   │  线下打款完成 → 确认打款                                                   │
   │                    │                                                     │
   │                    ▼                                                     │
   │  ┌─────────────────────────────────────────────────────────────────┐    │
   │  │ 1. 从冻结金额中扣除                                               │    │
   │  │ 2. 更新累计提现金额                                               │    │
   │  │ 3. 记录流水                                                       │    │
   │  │ 4. 更新申请状态为"已打款" (status = 3)                            │    │
   │  └─────────────────────────────────────────────────────────────────┘    │
   └──────────────────────────────────────────────────────────────────────────┘
```

### 12.2 充值流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              充值申请流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

1. 用户申请充值 (线下转账)
   ┌──────────────────────────────────────────────────────────────────────────┐
   │  选择账户类型 → 输入金额 → 上传转账凭证 → 提交申请                          │
   │                    │                                                     │
   │                    ▼                                                     │
   │  创建充值申请 (recharge_applications)                                     │
   │  status = 0 (待审核)                                                     │
   └──────────────────────────────────────────────────────────────────────────┘

2. 平台审核
   ┌──────────────────────────────────────────────────────────────────────────┐
   │  查看申请列表 → 核对转账凭证 → 审核通过/拒绝                                │
   │                    │                                                     │
   │         ┌──────────┴──────────┐                                          │
   │         ▼                     ▼                                          │
   │  ┌─────────────┐       ┌─────────────┐                                   │
   │  │ 审核通过     │       │ 审核拒绝     │                                   │
   │  │ 执行充值     │       │ 记录原因     │                                   │
   │  │ 记录流水     │       │             │                                   │
   │  └─────────────┘       └─────────────┘                                   │
   └──────────────────────────────────────────────────────────────────────────┘
```

### 12.3 申请状态

| 状态 | 值 | 说明 |
|------|-----|------|
| 待审核 | 0 | 用户已提交，等待平台审核 |
| 已通过 | 1 | 平台审核通过 |
| 已拒绝 | 2 | 平台审核拒绝 |
| 已打款 | 3 | 提现已完成打款 (仅提现) |

### 12.4 提现/充值相关代码文件

| 文件 | 说明 |
|------|------|
| `internal/models/account.go` | 申请模型定义 |
| `internal/services/account_service.go` | 提现/充值业务逻辑 |
| `admin/internal/handlers/shopower/account_handler.go` | 店主提现/充值 API |
| `admin/internal/handlers/operator/account_handler.go` | 运营提现 API |
| `admin/internal/handlers/platform/account_handler.go` | 平台审核 API |

---

## 十三、API 路由补充

### 13.1 店主账户路由 (/admin/shopower)

| 方法 | 路径 | 说明 |
|------|------|------|
| **账户** | | |
| GET | /account/prepayment | 获取预付款账户 |
| GET | /account/deposit | 获取保证金账户 |
| GET | /account/commission | 获取佣金账户 |
| GET | /account/summary | 获取所有账户汇总 |
| GET | /account/prepayment/transactions | 预付款流水 |
| GET | /account/deposit/transactions | 保证金流水 |
| GET | /account/commission/transactions | 佣金流水 |
| **提现** | | |
| POST | /withdraw/apply | 申请提现 |
| GET | /withdraw/list | 提现申请列表 |
| **充值** | | |
| POST | /recharge | 充值 |
| GET | /recharge/list | 充值申请列表 |

### 13.2 运营账户路由 (/admin/operator)

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /account | 获取运营账户 |
| GET | /account/transactions | 账户流水 |
| POST | /withdraw/apply | 申请提现 |
| GET | /withdraw/list | 提现申请列表 |

### 13.3 平台账户路由 (/admin/platform)

| 方法 | 路径 | 说明 |
|------|------|------|
| **账户管理** | | |
| GET | /accounts/prepayment | 预付款账户列表 |
| GET | /accounts/deposit | 保证金账户列表 |
| GET | /accounts/operator | 运营账户列表 |
| GET | /accounts/stats | 账户统计 |
| GET | /account/commission | 平台佣金账户 |
| GET | /account/commission/transactions | 平台佣金流水 |
| POST | /accounts/prepayment/recharge | 直接充值预付款 |
| POST | /accounts/deposit/pay | 直接缴纳保证金 |
| **提现审核** | | |
| GET | /withdraw/list | 提现申请列表 |
| POST | /withdraw/approve | 审批通过 |
| POST | /withdraw/reject | 审批拒绝 |
| POST | /withdraw/confirm_paid | 确认打款 |
| **充值审核** | | |
| GET | /recharge/list | 充值申请列表 |
| POST | /recharge/approve | 审批通过 |
| POST | /recharge/reject | 审批拒绝 |

---

## 十四、总结

### 订单流程

1. **数据来源**: 主动同步 + Webhook 推送
2. **存储**: orders + order_items + order_addresses
3. **关键服务**: `order_service.go`, `webhook_service.go`

### 账单流程

1. **数据来源**: 
   - `get_escrow_detail` → 单订单详细结算 → `order_escrows`
   - `get_wallet_transaction_list` → 批量交易流水 → `finance_incomes`
2. **同步方式**: 定时增量同步 (每5分钟)
3. **关键服务**: `escrow_service.go`, `finance_service.go`, `finance_sync_service.go`

### 账户体系

1. **店主账户**: 预付款 + 保证金 + 佣金
2. **运营账户**: 回款账户
3. **平台账户**: 佣金 + 罚补 + 托管
4. **关键服务**: `account_service.go`

### 结算流程

1. **发货**: 冻结预付款 → 转入托管
2. **结算**: 计算分成 → 各账户入账
3. **取消**: 解冻预付款 → 托管退回
4. **关键服务**: `settlement_service.go`, `operator/shipment_service.go`

### 提现/充值

1. **提现**: 申请 → 冻结 → 审核 → 打款
2. **充值**: 申请 → 审核 → 入账
3. **关键服务**: `account_service.go`

### 核心数据表

| 概念 | 说明 | 数据表 |
|------|------|--------|
| 订单 | 买家下单信息 | orders |
| 结算明细 | 单订单的详细结算分解 | order_escrows |
| 财务流水 | 钱包的所有交易记录 | finance_incomes |
| 预付款账户 | 店主预付款 | prepayment_accounts |
| 保证金账户 | 店主保证金 | deposit_accounts |
| 店主佣金账户 | 店主利润分成 | shop_owner_commission_accounts |
| 运营账户 | 运营回款 | operator_accounts |
| 平台佣金账户 | 平台利润分成 | platform_commission_accounts |
| 托管账户 | 临时托管 | escrow_accounts |
| 发货记录 | 运营发货记录 | order_shipment_records |
| 结算记录 | 订单结算记录 | order_settlements |
| 提现申请 | 提现申请记录 | withdraw_applications |
| 充值申请 | 充值申请记录 | recharge_applications |
| 账户流水 | 所有账户变动记录 | account_transactions |
