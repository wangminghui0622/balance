# 系统架构设计

## 1. 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              客户端层                                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │  店主前端   │  │  运营前端   │  │  平台前端   │  │  移动端APP  │    │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘    │
└─────────┼────────────────┼────────────────┼────────────────┼───────────┘
          │                │                │                │
          └────────────────┴────────────────┴────────────────┘
                                    │
                           ┌────────▼────────┐
                           │   Nginx/SLB     │
                           │  (负载均衡/SSL)  │
                           └────────┬────────┘
                                    │
┌───────────────────────────────────┼───────────────────────────────────┐
│                              应用层                                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                    │
│  │  Admin-1    │  │  Admin-2    │  │  Admin-3    │  (无状态，可扩展)  │
│  │  :8080      │  │  :8080      │  │  :8080      │                    │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                    │
└─────────┼────────────────┼────────────────┼───────────────────────────┘
          │                │                │
          └────────────────┴────────────────┘
                           │
┌──────────────────────────┼──────────────────────────┐
│                      数据层                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │   MySQL     │  │   Redis     │  │  Shopee API │  │
│  │  (分表120)  │  │  (缓存/锁)  │  │  (外部服务) │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  │
└─────────────────────────────────────────────────────┘
```

## 2. 模块架构

```
┌─────────────────────────────────────────────────────────────┐
│                        Router 路由层                         │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │
│  │  Auth   │  │Shopower │  │Operator │  │Platform │        │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘        │
└───────┼────────────┼────────────┼────────────┼──────────────┘
        │            │            │            │
┌───────┼────────────┼────────────┼────────────┼──────────────┐
│       ▼            ▼            ▼            ▼              │
│                      Handler 处理器层                        │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ AuthHandler | ShopHandler | OrderHandler | ...      │    │
│  └─────────────────────────┬───────────────────────────┘    │
└────────────────────────────┼────────────────────────────────┘
                             │
┌────────────────────────────┼────────────────────────────────┐
│                            ▼                                 │
│                      Service 服务层                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ AuthService  │  │ ShopService  │  │ OrderService │       │
│  ├──────────────┤  ├──────────────┤  ├──────────────┤       │
│  │AccountService│  │FinanceService│  │SettleService │       │
│  ├──────────────┤  ├──────────────┤  ├──────────────┤       │
│  │ SyncScheduler│  │ArchiveService│  │ StatsService │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└────────────────────────────┬────────────────────────────────┘
                             │
┌────────────────────────────┼────────────────────────────────┐
│                            ▼                                 │
│                      Database 数据层                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │   ShardedDB  │  │    Redis     │  │ ShopeeClient │       │
│  │  (分表路由)  │  │  (缓存/锁)   │  │  (API调用)   │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

## 3. 分表架构

### 3.1 分表策略

```
┌─────────────────────────────────────────────────────────────┐
│                      分表路由层                              │
│                                                              │
│   shop_id = 12345                                           │
│       │                                                      │
│       ▼                                                      │
│   shard_index = 12345 % 10 = 5                              │
│       │                                                      │
│       ▼                                                      │
│   ┌─────────────────────────────────────────────────────┐   │
│   │ orders_5 | order_items_5 | shipments_5 | ...        │   │
│   └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 分表列表

| 分表类型 | 数量 | 分表规则 |
|----------|------|----------|
| orders | 10 | shop_id % 10 |
| order_items | 10 | shop_id % 10 |
| order_addresses | 10 | shop_id % 10 |
| order_escrows | 10 | shop_id % 10 |
| order_escrow_items | 10 | shop_id % 10 |
| order_settlements | 10 | shop_id % 10 |
| order_shipment_records | 10 | shop_id % 10 |
| shipments | 10 | shop_id % 10 |
| finance_incomes | 10 | shop_id % 10 |
| operation_logs | 10 | shop_id % 10 |
| operation_logs_archive | 10 | shop_id % 10 |
| account_transactions | 10 | admin_id % 10 |
| **总计** | **120** | |

## 4. 分布式调度架构

```
┌─────────────────────────────────────────────────────────────┐
│                    分布式调度器                              │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              Redis 分布式锁/队列                     │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │    │
│  │  │scheduler:lock│  │shop:queue  │  │shop:processing│ │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  │    │
│  └─────────────────────────────────────────────────────┘    │
│                            │                                 │
│         ┌──────────────────┼──────────────────┐             │
│         │                  │                  │             │
│    ┌────▼────┐        ┌────▼────┐        ┌────▼────┐       │
│    │Worker-1 │        │Worker-2 │        │Worker-N │       │
│    │(Admin-1)│        │(Admin-2)│        │(Admin-3)│       │
│    └─────────┘        └─────────┘        └─────────┘       │
│                                                              │
│  调度器职责:                                                 │
│  - 订单同步: DistributedSyncScheduler                       │
│  - 财务同步: FinanceSyncScheduler                           │
│  - 日志归档: MaintenanceScheduler                           │
│  - 统计生成: MaintenanceScheduler                           │
└─────────────────────────────────────────────────────────────┘
```

## 5. 结算分成架构

```
┌─────────────────────────────────────────────────────────────┐
│                      订单结算流程                            │
│                                                              │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐  │
│  │订单完成 │───▶│获取结算 │───▶│计算分成 │───▶│入账     │  │
│  │         │    │明细     │    │         │    │         │  │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘  │
│                                      │                       │
│                    ┌─────────────────┼─────────────────┐    │
│                    │                 │                 │    │
│               ┌────▼────┐       ┌────▼────┐       ┌────▼────┐
│               │平台佣金 │       │运营分成 │       │店主分成 │
│               │ 10%     │       │ 30%     │       │ 60%     │
│               └────┬────┘       └────┬────┘       └────┬────┘
│                    │                 │                 │    │
│               ┌────▼────┐       ┌────▼────┐       ┌────▼────┐
│               │平台佣金 │       │运营账户 │       │店主佣金 │
│               │账户     │       │         │       │账户     │
│               └─────────┘       └─────────┘       └─────────┘
└─────────────────────────────────────────────────────────────┘
```

## 6. 监控架构

```
┌─────────────────────────────────────────────────────────────┐
│                      监控告警架构                            │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                   应用服务                           │    │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐             │    │
│  │  │/metrics │  │/health  │  │业务指标 │             │    │
│  │  └────┬────┘  └─────────┘  └────┬────┘             │    │
│  └───────┼─────────────────────────┼────────────────────┘    │
│          │                         │                         │
│          └────────────┬────────────┘                         │
│                       │                                      │
│                  ┌────▼────┐                                │
│                  │Prometheus│                                │
│                  │ (采集)   │                                │
│                  └────┬────┘                                │
│                       │                                      │
│         ┌─────────────┼─────────────┐                       │
│         │             │             │                       │
│    ┌────▼────┐   ┌────▼────┐   ┌────▼────┐                 │
│    │ Grafana │   │Alertmgr │   │ 告警    │                 │
│    │ (展示)  │   │ (告警)  │   │ 通知    │                 │
│    └─────────┘   └─────────┘   └─────────┘                 │
└─────────────────────────────────────────────────────────────┘
```

## 7. 数据流架构

### 7.1 订单同步流程

```
Shopee API ──▶ SyncScheduler ──▶ OrderService ──▶ ShardedDB
    │                                                  │
    │              ┌───────────────────────────────────┘
    │              │
    │         ┌────▼────┐
    │         │orders_X │ (X = shop_id % 10)
    │         └─────────┘
    │
    └──▶ Redis (状态缓存)
```

### 7.2 发货流程

```
用户请求 ──▶ ShipmentHandler ──▶ ShipmentService
                                       │
                    ┌──────────────────┼──────────────────┐
                    │                  │                  │
               ┌────▼────┐        ┌────▼────┐        ┌────▼────┐
               │Redis锁  │        │Shopee   │        │更新订单 │
               │(防重复) │        │发货API  │        │状态     │
               └─────────┘        └─────────┘        └─────────┘
```

## 8. 安全架构

```
┌─────────────────────────────────────────────────────────────┐
│                      安全防护层                              │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                    Nginx                             │    │
│  │  - SSL/TLS 加密                                      │    │
│  │  - 请求限流                                          │    │
│  │  - IP 白名单                                         │    │
│  └─────────────────────────────────────────────────────┘    │
│                            │                                 │
│  ┌─────────────────────────▼───────────────────────────┐    │
│  │                   应用层安全                         │    │
│  │  - JWT 认证                                          │    │
│  │  - 角色权限控制 (店主/运营/平台)                     │    │
│  │  - CORS 跨域控制                                     │    │
│  │  - 参数校验                                          │    │
│  └─────────────────────────────────────────────────────┘    │
│                            │                                 │
│  ┌─────────────────────────▼───────────────────────────┐    │
│  │                   数据层安全                         │    │
│  │  - 密码 Salt + Hash 存储                             │    │
│  │  - SQL 参数化查询 (防注入)                           │    │
│  │  - 敏感数据加密                                      │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

## 9. 高可用设计

| 组件 | 高可用方案 |
|------|-----------|
| 应用服务 | 多实例 + 负载均衡 |
| MySQL | 主从复制 + 自动切换 |
| Redis | Sentinel 哨兵模式 |
| 调度器 | 分布式锁 + 任务队列 |
| ID生成 | Redis Lua 原子操作 |

## 10. 扩展性设计

| 场景 | 扩展方案 |
|------|---------|
| 流量增长 | 水平扩展应用实例 |
| 数据增长 | 分表已支持，可扩展分表数量 |
| 店铺增长 | 分表按 shop_id 路由，自动分散 |
| 功能扩展 | 模块化设计，独立服务拆分 |
